# .github/workflows/rastreamento.yml

name: Atualizar Rastreios

on:
  # üîÅ Rodar automaticamente todos os dias √†s 03:59 da manh√£ (Brasil)
  schedule:
    - cron: '59 6 * * *'   # 06:59 UTC = 03:59 BRT

  # ‚ñ∂Ô∏è Permite rodar manualmente
  workflow_dispatch:

  # ü§ñ Permite disparo externo (webhook / API)
  repository_dispatch:
    types:
      - rodar-rastreamento

jobs:
  rastrear:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Instalar depend√™ncias
        run: |
          pip install --upgrade pip
          pip install -r requirements.tracking.txt

      # ===============================
      # üîµ FASE 1 ‚Äî LIMPEZA (EXECUTA)
      # ===============================
      - name: Mover pedidos encerrados
        env:
          GCP_SERVICE_ACCOUNT_BASE64: ${{ secrets.CREDENTIALS_BASE64 }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          python tracking/mover_encerrados.py

      # ===============================
      # üü¢ FASE 2 ‚Äî RASTREAMENTO (DECIDE)
      # ===============================
      - name: Atualizar rastreios ativos
        env:
          GCP_SERVICE_ACCOUNT_BASE64: ${{ secrets.CREDENTIALS_BASE64 }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          python tracking/rastreamento.py
